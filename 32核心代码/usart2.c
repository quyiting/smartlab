//???IO ??2   

#include "delay.h"
#include "usart2.h"
#include "stdarg.h"  
#include "stdio.h"  
#include "string.h"  
//???????
__align(8) u8 USART2_TX_BUF[USART2_MAX_SEND_LEN]; //????,??USART2_MAX_SEND_LEN??
#ifdef USART2_RX_EN   //???????     
//???????
u8 USART2_RX_BUF[USART2_MAX_RECV_LEN]; //????,??USART2_MAX_RECV_LEN???.


u16 USART2_RX_STA = 0;
void USART2_IRQHandler(void)
{
u8 res;     
if(USART_GetITStatus(USART2, USART_IT_RXNE) != RESET)  //????(?????????0x0d 0x0a??)
{
res =USART_ReceiveData(USART2);//(USART1->DR); //????????

if((USART2_RX_STA&0x8000)==0)//?????
{
if(USART2_RX_STA&0x4000)//????0x0d
{
if(res!=0x0a)USART2_RX_STA=0;//????,????
else USART2_RX_STA|=0x8000; //????? 
}
else //????0X0D
{ 
if(res==0x0d)USART2_RX_STA|=0x4000;
else
{
USART2_RX_BUF[USART2_RX_STA&0X3FFF]=res ;
USART2_RX_STA++;
if(USART2_RX_STA>(USART2_MAX_RECV_LEN-1))USART2_RX_STA=0;//??????,??????  
}  
}
}    
} 
   
}  
#endif 

//bound:???  
void usart2_init(u32 bound)
{  
NVIC_InitTypeDef NVIC_InitStructure;
GPIO_InitTypeDef GPIO_InitStructure;
USART_InitTypeDef USART_InitStructure;

//1.??????GPIO?????
RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOA,ENABLE); //??GPIOA??
RCC_APB1PeriphClockCmd(RCC_APB1Periph_USART2,ENABLE);//??USART2??
//2.????????? 
GPIO_PinAFConfig(GPIOA,GPIO_PinSource2,GPIO_AF_USART2); //GPIOA2???USART2
GPIO_PinAFConfig(GPIOA,GPIO_PinSource3,GPIO_AF_USART2); //GPIOA3???USART2  
//3.GPIO??????
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_2 | GPIO_Pin_3; //GPIOA2?GPIOA3???
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;//????
GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz; //??50MHz
GPIO_InitStructure.GPIO_OType = GPIO_OType_PP; //??????
GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_UP; //??
GPIO_Init(GPIOA,&GPIO_InitStructure); //???GPIOA2,?GPIOA3
//4.???????:?????,??,???????
USART_InitStructure.USART_BaudRate = bound;//????????9600;
USART_InitStructure.USART_WordLength = USART_WordLength_8b;//???8?????
USART_InitStructure.USART_StopBits = USART_StopBits_1;//?????
USART_InitStructure.USART_Parity = USART_Parity_No;//??????
USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;//????????
USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx; //????
USART_Init(USART2, &USART_InitStructure); //?????2??
//5.???NVIC
NVIC_InitStructure.NVIC_IRQChannel = USART2_IRQn;
NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority=0 ;//?????0
NVIC_InitStructure.NVIC_IRQChannelSubPriority = 3; //????3
NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE; //IRQ????
NVIC_Init(&NVIC_InitStructure); //??????????VIC???
//6.????
USART_ITConfig(USART2, USART_IT_RXNE, ENABLE);//????  
//7.????
USART_Cmd(USART2, ENABLE);                    //???? 
}


